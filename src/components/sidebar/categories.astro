---
import { getCategoryTree, type CategoryTreeItem } from "@utils/content";
import { widgetManager, getComponentConfig } from "@utils/widget";
import { i18n } from "@i18n/translation";
import I18nKey from "@i18n/i18nKey";
import WidgetLayout from "./widgetLayout.astro";
import CategoryItem from "./categoryItem.astro";


const categoriesTree = await getCategoryTree();

const COLLAPSED_HEIGHT = "7.5rem";

// 使用统一的组件管理器检查是否应该折叠
const categoriesComponent = getComponentConfig("categories");
const countNodes = (nodes: CategoryTreeItem[]): number =>
    nodes.reduce((total, node) => total + 1 + countNodes(node.children), 0);
const totalCategoriesCount = countNodes(categoriesTree);
const isCollapsed = categoriesComponent ? widgetManager.isCollapsed(categoriesComponent, totalCategoriesCount) : false;

interface Props {
    class?: string;
    style?: string;
    side?: string;
    depth?: number;
}
const { class: className, style, side = "default", depth } = Astro.props;
---

<WidgetLayout
    name={i18n(I18nKey.categories)}
    id={`categories-${side}`}
    isCollapsed={isCollapsed}
    collapsedHeight={COLLAPSED_HEIGHT}
    class={className}
    style={style}
>
    <CategoryItem nodes={categoriesTree} maxDepth={depth} />
</WidgetLayout>